# Модули
Принципиально новая концепция, появившаяся в Java 9.\
Модуль как единица развертывания приложений и управления зависимостями имеет семантическое значение для среды выполнения.\
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 65_

## Проблемы в Java до появления модулей
- Файлы JAR невидимы для среды выполнения.\
Фактически, они просто архивированные каталоги с файлами классов внутри
- Пакеты - просто пространства имен, которые группируют классы для управления доступом
- Зависимости определяются только на уровне классов
- Управление доступом в соечтании с рефлексией порождает открытую по сути систему без достаточного контроля

_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 65_

## Как все меняется с модулями
- Определяются зависимости между модулями и проблемы с расзрешением и компоновкой мообнаружить при компиляции или запуске
- Модули обеспечивают корректную инкапсуляцию
- Каждый модуль - полноценная единица развертывания с метаданными

_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 65_

## Основная идея
Основная идея состояла в том, чтобы модули можно было загружать и компоновать по отдельности, хотя на практике приложения могут зависеть от группы модулей, которые предоставляют смежную функциональность (средства инфо.беза, к примеру).\
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 66_

## Цели Jigsaw
- модуляризовать исходный код платформы JDK
- сократить потребление памяти процессами
- ускорить запуск приложений
- сделать модули доступными как для JDK, так и для кода приложений
- впервые в истории Java, обеспечить полноценную строгую инкапсуляцию
- добавить в язык Java новые, ранее невозможные режимы управления доступом

_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 66_

## Цели, ориентированыые на платформу
- отказать от одного монолитного JAR файласреды выполнения `rt.jar`
- эффективно инкапсулировать и обезопасить внутреннюю структуру JDK
- обеспечить возможность вносить серьезные внутренние изменения, в том числе те, которые блокируют несанкционированное использование вне JDK
- внедрить модули, как "суперпакеты"

_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 66_

## JAR, JMOD, JIMAGE
Отказ от формата JAR для классов платформы может принести немало преимуществ, включая значительное ускорение процесса запуска.\
Модули предоставляют два новых формата, которые используются на разных этапах жизненного цикла
- `JMOD` во время компиляции/компоновки.\
Похож на `JAR`, но позволяет включить в него низкоуровневый код как чать единого файла.
- `JIMAGE` во время выполнения.\
Предоставляет образ среды выполнения Java.

_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 67_

## Модули и зависимости
Модульное приложение содержит достаточно метаданных, чтобы точный набор зависимостей был известен до запуска программы.\
Таким образом, можно загружать только то, что действительно нужно, что повышает эффективность.\
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 67_

## Специальный образ и jlink
Можно определить специальный образ среды выполнения, который будет поставляться вместе с приложением и содержать полную саму Java и все, что нужно приложению для работы.\
Для этого используется `jlink`\
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 67_

## Вывод информации с помощью jimage info
`jimage` выводит полную информацию об образе среды выполнения Java.\
```shell
> jimage info C:\"Program Files"\Java\jdk-17\lib\modules
 Major Version:  1
 Minor Version:  0
 Flags:          0
 Resource Count: 29192
 Table Length:   29192
 Offsets Size:   116768
 Redirects Size: 116768
 Locations Size: 602267
 Strings Size:   641811
 Index Size:     1477642
```
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 67_

## Вывод списка модулей и их состава с помощью jimage list
```shell
> jimage: C:\Program Files\Java\jdk-17\lib\modules

Module: java.base
    META-INF/services/java.nio.file.spi.FileSystemProvider
    com/sun/crypto/provider/AESCipher$AES128_CBC_NoPadding.class
    com/sun/crypto/provider/AESCipher$AES128_CFB_NoPadding.class
    com/sun/crypto/provider/AESCipher$AES128_ECB_NoPadding.class
    com/sun/crypto/provider/AESCipher$AES128_OFB_NoPadding.class
    ...
Module: java.xml
    com/sun/java_cup/internal/runtime/Scanner.class
    com/sun/java_cup/internal/runtime/Symbol.class
    com/sun/java_cup/internal/runtime/lr_parser.class
    ...
...    
```
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 67_

## Польза от отказа от rt.jar
Отказ от монолитного `rt.jar` позволяет ускорить запуск и оптимизировать среду только для тех компонентов, которые необходимы приложению.\
Новые форматы проектировались, как **непрозрачные** для разработчиков, и они зависят от реализации.\
Теперь нельзя просто распаковать `rt.jar` и получить библиотеку классов JDK.\
Это один из шагов, чтобы закрыть внутреннюю структуру платформы от программистов Java.\
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 68_

## Проблема инкапсуляции в Java 8 и ранее
Вносить критические изменения во внутреннее устройство платформы мешал подход к управлению доступом, существовавший в Java 8.\
В Java определены только модификаторы `public`, `private`, `protected` и `package-private`, и они применяются лишь на уровне класса и ниже.\
К тому же, эти ограничения можно было обойти разными способами.\
Таким образом, доступ к "технической изнанке" мешал развивать платформу, не давая никаких преимуществ.\
Модульность помогла решить эту проблему.\
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 68-69_

## Модули в STackTrace-е
[Пример](./examples/stack_trace_example/Main.java)
```java
var i = Integer.parseInt("Ошибка");
```
Приводит к
```shell
Exception in thread "main" java.lang.NumberFormatException: For input string: "Ошибка"
	at java.base/java.lang.NumberFormatException.forInputString(NumberFormatException.java:67)
	at java.base/java.lang.Integer.parseInt(Integer.java:662)
	at java.base/java.lang.Integer.parseInt(Integer.java:778)
	at knowledge.base.module.example/stack_trace_example.Main.main(Main.java:5)
```
Кадры стека обозначаются **именем модуля**, именем пакета, классом и номером строки.\
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 69_

## Граф модулей
Краеугольным камнем всей модульности является **граф модулей** - представление того, как одни модули зависят от других.\
Модули явно выражают свои зависимости с помощью нового синтаксиса.\
Эти зависимости служат твердыми гарантиями, которыми могут пользоваться и компилятор, и среда выполнения.\
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 69_

### Циклические зависимости в графе модулей
Граф модулей должен быть направленным ациклическим графом (НАГ или DAG), а следовательно не может содержать циклических зависимостей.\
_Б.Эванс, Java для опытных разработчиков. Второе издание. стр. 69_
