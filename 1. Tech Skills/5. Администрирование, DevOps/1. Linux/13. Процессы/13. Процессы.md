# Процессы
## Скрипты инициализации
В момент запуска системы ядро инициализирует выполнение нескольких собственных задач в виде процессов и запускает программу `init`.
В свою очередь, `init` выполняет последовательность сценариев начальной загрузки (**init scripts**) в `/etc`, которые запускают все системные службы.
Многие из них реализованы, как демоны (**daemon**), действующие в фоновом режиме.
*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 145*

## Команда ps
Используется для просмотра списка процессов
```shell
$ ps
    PID TTY          TIME CMD
  18405 pts/0    00:00:00 bash
  18420 pts/0    00:00:00 ps
$
```

| Поле   | Пояснение                                                                                                |
|--------|----------------------------------------------------------------------------------------------------------|
| `PID`  | Идентификатор процессе. Присваивается в порядке возрастания.<br/>Процесс `init` имеет идентификатор `1`. |
| `TTY`  | Управляющий терминал                                                                                     |
| `TIME` | содержит объем процессорного времени, потребленного процессом                                            |
Помимо прочего, ядро системы следит за памятью, выделяемой каждому процессу.
*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 145*
### ps x
Параметр `x` позволяет вывести все процессы независимо от того, какие терминалы управляют ими и получить информацию о состоянии (`STAT`)
Стоит обратить внимание на отсутствие дефиса.

```sh
$ ps x
    PID TTY      STAT   TIME COMMAND
   2957 ?        Ss     0:00 /usr/lib/systemd/systemd --user
   2958 ?        S      0:00 (sd-pam)
   2970 ?        Ssl    0:04 /opt/paloaltonetworks/globalprotect/PanGPA start
   2971 ?        S<sl   4:18 /usr/bin/pipewire
   2973 ?        Ssl    0:00 /usr/bin/pipewire -c filter-chain.conf
   2974 ?        S<sl   0:01 /usr/bin/wireplumber
   ...
$
```
Символ `?` в `TTY` указывает на отсутствие управляющего терминала.
В столбце `STAT` содержится информация о состоянии процесса. Некоторые из кодов:

| Состояние | Описание                                                               |
| --------- | ---------------------------------------------------------------------- |
| `R`       | Выполняется или готов к выполнению                                     |
| `S`       | Приостановлен. Возможно, ждет чего нибудь типа, нажатия клавиши        |
| `D`       | Приостановлен без возможности прерывания. Ждем чтения диска, к примеру |
| `T`       | Остановлен                                                             |
| `Z`       | Зомби                                                                  |
| `<`       | Высокоприоритетный                                                     |
| `N`       | Низкоприоритетный                                                      |
*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 146*
### ps aux
Выводит процессы, принадлежащие всем пользователям и добавляет еще поля
```sh
$ ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.0  23144 13388 ?        Ss   09:23   0:02 /sbin/init splash
root           2  0.0  0.0      0     0 ?        S    09:23   0:00 [kthreadd]
root           3  0.0  0.0      0     0 ?        S    09:23   0:00 [pool_workqueue_release]
root           4  0.0  0.0      0     0 ?        I<   09:23   0:00 [kworker/R-rcu_g]
root           5  0.0  0.0      0     0 ?        I<   09:23   0:00 [kworker/R-rcu_p]
root           6  0.0  0.0      0     0 ?        I<   09:23   0:00 [kworker/R-slub_]
root           7  0.0  0.0      0     0 ?        I<   09:23   0:00 [kworker/R-netns]
...
$
```

Новые поля:

| Заголовок | Значение                                                            |
| --------- | ------------------------------------------------------------------- |
| `USER`    | Владелец процесса                                                   |
| `%CPU`    | Использование процессора в процентах                                |
| `%MEM`    | Использование памяти в процентах                                    |
| `VSZ`     | Объем виртуальной памяти                                            |
| `RSS`     | Объем физической памяти, используемой процессом                     |
| `START`   | Время запуска процесса. Для значений больше 24 часов выводится дата |
*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 147*
## top
Постоянно обновляет информацию (каждые 3 секунды по умолчанию).
Вывод как блок со сводкой, так и список наиболее активных процессов
```sh
top - 12:38:59 up  3:15,  1 user,  load average: 0,50, 0,71, 0,80
Tasks: 507 total,   2 running, 505 sleeping,   0 stopped,   0 zombie
%Cpu(s):  1,2 us,  1,0 sy,  0,1 ni, 97,6 id,  0,1 wa,  0,0 hi,  0,0 si,  0,0 st 
МиБ Mem :  15711,6 total,    662,1 free,  11884,0 used,   5122,8 buff/cache     
МиБ Swap:   2048,0 total,    988,2 free,   1059,8 used.   3827,6 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                                                                                                           
  22991 akhitev   20   0 3805516 643360 558392 S  15,0   4,0   4:07.93 VirtualBoxVM                                                                                                                                                      
   5892 akhitev   20   0 7812876 520376 107792 S   6,2   3,2  60:43.73 zoom                                                                                                                                                              
   2975 akhitev    9 -11  138764  25020   8672 S   4,7   0,2   6:59.57 pipewire-pulse                                                                                                                                                    
   1954 root      20   0 1472724 164088 125516 S   3,8   1,0   8:26.77 Xorg                                                                                                                                                              
   3393 akhitev   20   0 4967188 182488 103840 S   3,5   1,1  11:20.21 cinnamon                                                                                                                                                          
   2971 akhitev    9 -11  121772  19052   9476 S   3,2   0,1   4:56.73 pipewire
   ...
```
### Первая строка

| Поле                             | Значение                                 |
| -------------------------------- | ---------------------------------------- |
| `top`                            | Имя программы                            |
| `12:38:59`                       | Текущее время                            |
| `up  3:15`                       | Продолжительность работы                 |
| `1 user`                         | Сколько пользователей работают в системе |
| `load average: 0,50, 0,71, 0,80` | Средняя нагрузка                         |

### Вторая строка

| Поле                                                                      | Значение                                      |
| ------------------------------------------------------------------------- | --------------------------------------------- |
| `Tasks: 507 total,   2 running, 505 sleeping,   0 stopped,   0 zombie`    | Суммарное число процессов в разных состояниях |
| `Mem :  15711,6 total,    662,1 free,  11884,0 used,   5122,8 buff/cache` | Объем используемой ОЗУ                        |
| `Swap:   2048,0 total,    988,2 free,   1059,8 used.   3827,6 avail Mem`  | Объем использованного файла подкачки          |
### Команды внутри
`h` выводит справочную информацию
`q` повзоляет выйти

*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 148-150*

## Прерываение процесса
`Ctrl` + `C` прерывает запущенный сейчас в консоле процесс
*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 151*
## Фоновый режим
Можно представить, что терминал имеет передний план (foreground) и задний план (background).
Выполнение в фоне полезно при запуске программ с GUI из консоли (если программы нет в списке приложений или нужно посмотреть сообщения об ошибках).
Процесс в фоновом режиме не получает ввода с клавиутары, в том числе `Ctrl` + `C`
### Запуска в фоне
Для запуска команды в фоновом режиме нужно добавить в конце `&`
```sh
$ ping 8.8.8.8 > /dev/null &
[1] 24468
$
```
Вывод `[1] 24468` - информация от механизма управления заданиями (job control), в котором:
- `1` - номер задания
- `24468` - PID задания
### Получение списка фоновых заданий
Команда `jobs` позволяет получить список запущенных в терминале заданий
```sh
$ jobs
[1]-  Запущен          ping 8.8.8.8 > /dev/null &
[2]+  Запущен          ping 8.8.8.8 > /dev/null &
$
```
### Возврат задания на передний план
Вернуть процесс на передний план можно при помощи команды `fg спецификатор_задания`.
Спецификатор задания (jobspec) строится, как `%` и номер задания.
Если задание только одно, спецификатор можно опустить.
```sh
$ fg %2
ping 8.8.8.8 > /dev/null


```
### Приостановка выполнения
Приостановить выполнение программы можно комбинацией клавиш `Ctrl` + `Z`
```sh
$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=108 time=7.35 ms
^Z
[3]+  Остановлен    ping 8.8.8.8
$
```
### Возврат в фоновых режим
Приостановленную команду можно вернуть для выполнения в фоне командой `bg мпецификатор_задания`
```sh
$ jobs
[1]-  Запущен          ping 8.8.8.8 > /dev/null &
[2]+  Остановлен    ping 8.8.8.8 > /dev/null
akhitev@akhitev-laptop:~$ bg %2
[2]+ ping 8.8.8.8 > /dev/null &
akhitev@akhitev-laptop:~$ jobs
[1]-  Запущен          ping 8.8.8.8 > /dev/null &
[2]+  Запущен          ping 8.8.8.8 > /dev/null &
$
```
*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 151-153*
## Отправка сигналов, kill
Команду `kill [-сигнал] PID` можно использовать для отправки сигнала процессу.
По умолчанию, отправляется сигнал `TERM`.
Полный список сигналов можно получить выполнив `kill -l`
### Частые сигналы:
| Номер | Имя     | Значение                                                                                                                                                                                       |
| ----- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `1`   | `HUP`   | Обрыв связи. Демоны получая такой сигнал перезапускаются и перечитывают свою конфигурацию                                                                                                      |
| `2`   | `INT`   | Прерывание. Его и отправляет `Ctrl` + `C`                                                                                                                                                      |
| `9`   | `KILL`  | Уничтожить. Ядро немедленно завершает работу процесса. Следует использовать, как последнее средство, т.к. программа не имеет возможности "прибраться" за собой или сохранить результаты работы |
| `15`  | `TERM`  | Завершить. Если программа достаточно "живая", чтоб принять сигнал - она завершится                                                                                                             |
| `18`  | `CONT`  | Продолжить. Работа восстанавливается после сигнала `STOP`                                                                                                                                      |
| `19`  | `STOP`  | Приостановить. Не может быть проигнорирован процессом, как и `KILL`, потому что обрабатывается в ядре                                                                                          |
| `20`  | `TSTP`  | В отличии от `STOP` передается программе. Этот сигнал отправляется при нажатии `Ctrl` + `Z`                                                                                                    |
| `28`  | `WINCH` | Изменение размеров окна терминала                                                                                                                                                              |
*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 154-156*
### killall
Используя поканду `killall [-u пользователь] [-сигнал] имя...` можно отправить сигнал сразу нескольким процессам
*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 156*
## Завершение работы системы
Перед отключением питания, системе нужно по порядку завершить все выполняющиеся процессы и выполнить служебные операции (к примеру, синхронизация смонтированных дисков).
Для этого существуют команды:
- `halt`
- `poweroff`
- `reboot`
- `shutdown`
Первые 3 выполняются без параметров, а в `shutdown` нужно передать действие.
Кроме того, в `shutdown` можно задать задержку перед выключением.
При выполнении команды `shutdown`, система разошлет сообщение о событии всем активным пользователям системы.
### Остановка системы

```sh
shutdown -h now
```
### Перезагрузка системы
```sh
shutdown -r now
```
*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 157*
## pstree
Выводит список процессов в древовидной форме, отражающей связь родитель/потомок
```sh
$ pstree
systemd─┬─ModemManager───3*[{ModemManager}]
        ├─NetworkManager───3*[{NetworkManager}]
        ├─PanGPS───12*[{PanGPS}]
        ├─VBoxSVC─┬─VirtualBoxVM───46*[{VirtualBoxVM}]
        │         └─17*[{VBoxSVC}]
		...
$
```
## vmstat
Выводит снимок с информацией об использовании системных ресурсов, включая ОЗУ, файл подкачки, объем дискового пространства.
```sh
$ vmstat
procs -----------memory---------- ---swap-- -----io---- -system-- -------cpu-------
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st gu
 0  0 1130752 619444 236212 5225652   11   69   462   391 9050    6  3  1 96  0  0  0
$
```
Можно запустить непрерывный просмотр с интервалом (прерывается по `Ctrl` + `C)
```sh
$ vmstat 5
procs -----------memory---------- ---swap-- -----io---- -system-- -------cpu-------
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st gu
 2  0 1130752 657484 236800 5203700   11   69   460   391 9054    6  3  1 96  0  0  0
 0  0 1130752 665708 236808 5195460    0    0     0   125 8992 11696  1  1 98  0  0  0
^C
$
```
*Командная строка Linux. Полное руководство. 2-е межд. изд., стр. 158*